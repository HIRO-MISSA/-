<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>なごみの郷 面会予約システム</title>
    <style>
        /* 全体リセットと基本スタイル */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', 'Meiryo', sans-serif;
            background: linear-gradient(135deg, #e8f5e8 0%, #d4f4d4 100%); /* グラデーション背景 */
            min-height: 100vh;
            padding: 20px;
            display: flex; /* 中央揃えのために追加 */
            justify-content: center; /* 水平方向の中央揃え */
            align-items: center; /* 垂直方向の中央揃え */
        }
        .container {
            max-width: 800px;
            width: 100%; /* レスポンシブ対応 */
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex; /* Flexboxで縦並びにする */
            flex-direction: column;
        }
        .header {
            background: linear-gradient(135deg, #4a7c59 0%, #5d8a6b 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 2.2em; margin-bottom: 10px; font-weight: 600; }
        .header p { font-size: 1.1em; opacity: 0.9; }

        /* トップ画面のボタン共通スタイル */
        .top-button {
            display: block; /* ブロック要素にして幅を100%にする */
            text-align: center;
            text-decoration: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1.1em; /* 少し大きめに */
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%; /* 幅いっぱいにする */
            margin-top: 15px; /* ボタン間のスペース */
            color: white; /* デフォルトの文字色 */
            border: none; /* 枠線なし */
        }

        .top-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* 各ボタンの個別スタイル */
        .submit-reservation-button {
            background: linear-gradient(135deg, #4a7c59 0%, #5d8a6b 100%); /* 予約を送信ボタンのグラデーション */
        }
        .submit-reservation-button:hover {
            box-shadow: 0 5px 15px rgba(74, 124, 89, 0.3);
        }

        .reception-button {
            background-color: #FFD700; /* 黄色 */
            color: #000000;             /* 黒 */
        }
        .reception-button:hover {
            background-color: #e0c200; /* 少し濃い黄色 */
        }

        .cancel-button {
            background-color: #dc3545; /* 赤色 */
        }
        .cancel-button:hover {
            background-color: #c82333;
        }

        .staff-button {
            background: #6c757d; /* 職員専用ボタンのグレー */
        }
        .staff-button:hover {
            background: #5a6268;
        }

        .form-container {
            padding: 40px;
            flex-grow: 1; /* 残りのスペースを埋める */
        }
        .form-group { margin-bottom: 25px; }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d4a35;
            font-size: 1.1em;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
            font-family: inherit;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4a7c59;
        }
        .form-group textarea { resize: vertical; min-height: 100px; }
        .required { color: #e74c3c; }

        .facility-info {
            background: #f8fcf8;
            padding: 25px;
            border-top: 1px solid #e0e0e0;
        }
        .facility-info h3 {
            color: #2d4a35;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        .info-item { margin-bottom: 8px; color: #4a4a4a; }
        .info-item strong { color: #2d4a35; }

        /* 確認画面のスタイル */
        .confirmation {
            display: none;
            background: #e8f5e8;
            padding: 30px;
            text-align: center;
            border-radius: 10px;
            margin: 20px 0;
        }
        .confirmation h3 {
            color: #4a7c59;
            margin-bottom: 15px;
            font-size: 1.5em;
        }
        .confirmation-details {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: left;
        }
        .confirmation-details p { margin-bottom: 8px; color: #4a4a4a; }
        .confirmation-details strong { color: #2d4a35; }
        .reservation-number {
            background: #4a7c59;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 1.3em;
            font-weight: bold;
        }
        .new-reservation-button {
            background: #4a7c59;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 20px;
        }
        .new-reservation-button:hover { background: #5d8a6b; }

        /* モーダル共通スタイル */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            margin: auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            right: 15px;
            top: 15px;
            cursor: pointer;
        }
        .close:hover { color: black; }
        .modal h3 {
            color: #2d4a35;
            margin-bottom: 20px;
            font-size: 1.4em;
        }
        .modal-detail {
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .modal-detail strong { color: #2d4a35; }
        .status-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .status-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            transition: all 0.3s;
        }
        .status-btn.confirmed { background: #d4edda; color: #155724; }
        .status-btn.completed { background: #d1ecf1; color: #0c5460; }
        .status-btn.cancelled { background: #f8d7da; color: #721c24; }
        .status-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* 職員管理画面スタイル */
        .staff-panel {
            display: none; /* 初期状態では非表示 */
            background: white;
            padding: 30px;
            border-radius: 15px; /* コンテナと同じ丸み */
            box-shadow: 0 8px 32px rgba(0,0,0,0.1); /* コンテナと同じ影 */
            margin: 20px auto; /* 中央揃え */
            max-width: 800px; /* コンテナと同じ幅 */
            width: 100%;
        }
        .staff-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }
        .staff-header h2 { color: #2d4a35; font-size: 1.8em; }
        .back-button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
        }
        .back-button:hover { background: #5a6268; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #f8fcf8 0%, #e8f5e8 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e0e0e0;
        }
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #4a7c59;
            margin-bottom: 5px;
        }
        .stat-label { color: #2d4a35; font-size: 1.1em; }
        .reservations-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .table-header {
            background: #4a7c59;
            color: white;
            padding: 15px;
            font-size: 1.2em;
            font-weight: bold;
        }
        .table-content { max-height: 500px; overflow-y: auto; }
        .reservation-item {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            display: grid;
            grid-template-columns: 100px 1fr 1fr 1fr 1fr 1fr 100px; /* 7 columns for staff view */
            gap: 15px;
            align-items: center;
        }
        .reservation-item:nth-child(even) { background: #f8f9fa; }
        .reservation-item:hover { background: #f0f8f0; }
        .reservation-field { font-size: 0.9em; }
        .reservation-field strong { display: block; margin-bottom: 3px; }
        .reservation-number-display {
            background: #4a7c59;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 0.9em;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .reservation-number-display:hover {
            background: #5d8a6b;
            transform: translateY(-1px);
        }
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .status-badge:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-confirmed { background: #d4edda; color: #155724; }
        .status-completed { background: #d1ecf1; color: #0c5460; }
        .status-cancelled { background: #f8d7da; color: #721c24; }
        .filter-section {
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        .filter-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #2d4a35;
        }
        .filter-group input,
        .filter-group select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9em;
        }
        .filter-button {
            background: #4a7c59;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            height: fit-content;
        }
        .filter-button:hover { background: #5d8a6b; }

        .delete-old-data-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }
        .delete-old-data-section h3 {
            color: #721c24;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        .delete-old-data-section .delete-row {
            display: flex;
            align-items: end;
            gap: 15px;
        }
        .delete-old-data-section .delete-row label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #2d4a35;
        }
        .delete-old-data-section .delete-button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            height: fit-content;
            transition: all 0.3s;
        }
        .delete-old-data-section .delete-button:hover {
            background: #c0392b;
            transform: translateY(-1px);
        }

        @media (max-width: 600px) {
            .header h1 { font-size: 1.8em; }
            .form-container { padding: 20px; }
            .reservation-item { grid-template-columns: 1fr; gap: 10px; }
            .filter-row { grid-template-columns: 1fr; }
            .status-buttons { flex-direction: column; }
            .delete-old-data-section .delete-row { flex-direction: column; align-items: stretch; }
            .delete-old-data-section .delete-button { width: 100%; }
            .container { padding: 0; } /* スマホでの余白調整 */
            body { padding: 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>なごみの郷 面会予約システム</h1>
            <p>オンラインで簡単に面会予約ができます</p>
        </div>
        <div class="form-container" id="userFormContainer">
            <form id="reservationForm">
                <div class="form-group">
                    <label for="residentName">入居者様のお名前 <span class="required">*</span></label>
                    <input type="text" id="residentName" name="residentName" required>
                </div>
                <div class="form-group">
                    <label for="visitorName">面会者様のお名前 <span class="required">*</span></label>
                    <input type="text" id="visitorName" name="visitorName" required>
                </div>
                <div class="form-group">
                    <label for="relationship">ご関係 <span class="required">*</span></label>
                    <input type="text" id="relationship" name="relationship" placeholder="例: 息子、娘、配偶者" required>
                </div>
                <div class="form-group">
                    <label for="visitDate">面会希望日 <span class="required">*</span></label>
                    <input type="date" id="visitDate" name="visitDate" required>
                </div>
                <div class="form-group">
                    <label for="selectedTime">面会希望時間 <span class="required">*</span></label>
                    <select id="selectedTime" name="selectedTime" required>
                        <option value="">選択してください</option>
                        <option value="10:00">10:00</option>
                        <option value="10:30">10:30</option>
                        <option value="11:00">11:00</option>
                        <option value="11:30">11:30</option>
                        <option value="12:00">12:00</option>
                        <option value="12:30">12:30</option>
                        <option value="13:00">13:00</option>
                        <option value="13:30">13:30</option>
                        <option value="14:00">14:00</option>
                        <option value="14:30">14:30</option>
                        <option value="15:00">15:00</option>
                        <option value="15:30">15:30</option>
                        <option value="16:00">16:00</option>
                        <option value="16:30">16:30</option>
                        <option value="17:00">17:00</option>
                        <option value="17:30">17:30</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="visitorCount">面会者数</label>
                    <select id="visitorCount" name="visitorCount">
                        <option value="1">1名</option>
                        <option value="2">2名</option>
                        <option value="3">3名</option>
                        <option value="4">4名</option>
                        <option value="5">5名以上</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="notes">備考・特別な配慮事項</label>
                    <textarea id="notes" name="notes" placeholder="アレルギー、健康状態、車椅子使用など"></textarea>
                </div>

                <button type="submit" class="top-button submit-reservation-button">予約を送信</button>
                <button type="button" id="receptionBtn" class="top-button reception-button">来設受付</button>
                <button type="button" id="cancelTopButton" class="top-button cancel-button">予約をキャンセル</button>
                <button type="button" id="staffButton" class="top-button staff-button">職員専用</button>
            </form>

            <div id="receptionModal" class="modal">
                <div class="modal-content">
                    <span class="close" id="closeReceptionModalBtn">&times;</span>
                    <h3>来設受付</h3>
                    <div style="margin-bottom:15px;">受付番号（予約番号）と体温を入力してください。</div>
                    <input type="text" id="receptionNumberInput" style="width:100%;padding:10px;font-size:1em;border-radius:5px;border:1px solid #ddd;margin-bottom:10px;" placeholder="例: 20250720-01">
                    <input type="number" id="receptionTempInput" style="width:100%;padding:10px;font-size:1em;border-radius:5px;border:1px solid #ddd;" placeholder="体温（例：36.7）" min="34" max="42" step="0.1">
                    <div id="receptionResult" style="margin:15px 0;color:#4a7c59;"></div>
                    <button type="button" class="submit-btn" id="completeReceptionBtn" style="width:100%;">受付を完了する</button>
                </div>
            </div>

            <div id="topCancelModal" class="modal">
                <div class="modal-content">
                    <span class="close" id="closeTopCancelModalBtn">&times;</span>
                    <h3>予約キャンセル</h3>
                    <p style="margin-bottom: 15px;">キャンセルする予約の予約番号を入力してください。</p>
                    <input type="text" id="cancelReservationNumberInput" style="width:100%;padding:10px;font-size:1em;border-radius:5px;border:1px solid #ddd;margin-bottom:10px;" placeholder="例: 20250720-01">
                    <div id="topCancelResult" style="margin:15px 0;color:#721c24;"></div>
                    <button type="button" class="submit-btn" id="confirmCancelBtn" style="background:#dc3545;">キャンセルを実行</button>
                </div>
            </div>

            <div class="confirmation" id="confirmation">
                <h3>面会予約を受け付けました</h3>
                <div class="reservation-number" id="reservationNumber"></div>
                <p>ご予約ありがとうございます。以下の内容でご予約を受け付けいたしました。</p>
                <div class="confirmation-details" id="confirmationDetails"></div>
                <button class="new-reservation-button" id="newReservationBtn">新しい予約を作成</button>
            </div>
        </div>

        <div class="staff-panel" id="staffPanel">
            <div class="staff-header">
                <h2>職員管理画面</h2>
                <button class="back-button" id="backUserFormBtn">利用者画面に戻る</button>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalReservations">0</div>
                    <div class="stat-label">総予約数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="todayReservations">0</div>
                    <div class="stat-label">本日の予約</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pendingReservations">0</div>
                    <div class="stat-label">承認待ち</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completedReservations">0</div>
                    <div class="stat-label">完了済み</div>
                </div>
            </div>
            <div class="filter-section">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="filterDate">日付</label>
                        <input type="date" id="filterDate">
                    </div>
                    <div class="filter-group">
                        <label for="filterStatus">ステータス</label>
                        <select id="filterStatus">
                            <option value="">すべて</option>
                            <option value="pending">承認待ち</option>
                            <option value="confirmed">承認済み</option>
                            <option value="completed">完了</option>
                            <option value="cancelled">キャンセル</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterResident">入居者名</label>
                        <input type="text" id="filterResident" placeholder="入居者名で検索">
                    </div>
                    <div class="filter-group">
                        <button class="filter-button" id="applyFiltersBtn">フィルター適用</button>
                    </div>
                </div>
            </div>
            <div class="reservations-table">
                <div class="table-header">面会予約一覧</div>
                <div class="table-content" id="reservationsList"></div>
            </div>

            <div class="delete-old-data-section">
                <h3>過去の面会予約データを削除</h3>
                <p>指定した日付より過去の「完了」ステータスの予約を削除します。この操作は元に戻せません。</p>
                <div class="delete-row">
                    <div class="filter-group" style="flex-grow: 1;">
                        <label for="deleteDate">削除対象日（この日付より過去）</label>
                        <input type="date" id="deleteDate">
                    </div>
                    <button class="delete-button" id="deleteOldReservationsBtn">削除実行</button>
                </div>
            </div>
        </div>
        <div class="facility-info">
            <h3>施設情報</h3>
            <div class="info-item"><strong>施設名:</strong> 特別養護老人ホーム・ケアハウス なごみの郷</div>
            <div class="info-item"><strong>所在地:</strong> 〒739-1732 広島県広島市安佐南区沼田南町196-1</div>
            <div class="info-item"><strong>面会時間:</strong> 10:00～17:30 / 年中無休</div>
            <div class="info-item"><strong>お問い合わせ:</strong> 082-841-1331</div>
        </div>
    </div>

    <div id="reservationModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeReservationModalBtn">&times;</span>
            <h3>予約詳細</h3>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {

            // 予約データ管理
            function loadReservations() {
                const data = localStorage.getItem('nagomi_reservations');
                if (data) { try { return JSON.parse(data); } catch { return []; } }
                return [];
            }

            function saveReservations() {
                localStorage.setItem('nagomi_reservations', JSON.stringify(reservations));
            }

            let reservations = loadReservations();
            // 初期データの設定 (初回アクセス時のみ適用)
            if (!reservations || !Array.isArray(reservations) || reservations.length === 0) {
                reservations = [
                    {id:1,reservationNumber:"20250717-01",residentName:"田中 花子",visitorName:"田中 太郎",relationship:"息子",visitDate:"2025-07-17",visitTime:"14:00",visitorCount:"2",status:"pending",notes:"車椅子使用",createdAt:"2025-07-16 10:30",temperature:""},
                    {id:2,reservationNumber:"20250716-01",residentName:"佐藤 一郎",visitorName:"佐藤 良子",relationship:"配偶者",visitDate:"2025-07-16",visitTime:"15:30",visitorCount:"1",status:"completed",notes:"",createdAt:"2025-07-15 14:20",temperature:"36.5"},
                    {id:3,reservationNumber:"20250718-01",residentName:"山田 次郎",visitorName:"山田 良子",relationship:"娘",visitDate:"2025-07-18",visitTime:"11:00",visitorCount:"3",status:"confirmed",notes:"お孫さんも一緒に来られます",createdAt:"2025-07-16 09:15",temperature:""},
                    {id:4,reservationNumber:"20250719-01",residentName:"鈴木 健太",visitorName:"鈴木 綾子",relationship:"妻",visitDate:"2025-07-19",visitTime:"10:00",visitorCount:"1",status:"pending",notes:"",createdAt:"2025-07-17 11:00",temperature:""},
                    {id:5,reservationNumber:"20250720-01",residentName:"高橋 静江",visitorName:"高橋 浩",relationship:"夫",visitDate:"2025-07-20",visitTime:"14:30",visitorCount:"2",status:"confirmed",notes:"お土産持参",createdAt:"2025-07-18 13:45",temperature:""}
                ];
                saveReservations(); // 初期データを保存
            }

            // 面会希望日の最小値を今日に設定
            document.getElementById('visitDate').min = new Date().toISOString().split('T')[0];

            function formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' });
            }

            function getStatusText(status) {
                switch(status) {
                    case 'pending': return '承認待ち';
                    case 'confirmed': return '承認済み';
                    case 'completed': return '完了';
                    case 'cancelled': return 'キャンセル';
                    default: return status;
                }
            }

            function generateReservationNumber(visitDate) {
                const dateString = visitDate.replace(/-/g, '');
                // 全ての予約（キャンセル済み含む）を対象に、その日の予約数をカウントしてユニークな番号を生成
                const allReservationsForDate = loadReservations().filter(r => r.visitDate === visitDate);
                const nextNumber = allReservationsForDate.length + 1;
                if (nextNumber > 50) throw new Error('その日は予約が満席です（1日最大50件まで）');
                return `${dateString}-${nextNumber.toString().padStart(2, '0')}`;
            }

            // 予約フォーム送信処理
            document.getElementById('reservationForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                const visitDate = formData.get('visitDate');
                if (!visitDate) { alert('面会日を選択してください。'); return; }
                const today = new Date().toISOString().split('T')[0];
                if (visitDate < today) { alert('過去の日付は選択できません。'); return; }

                // 選択された時間がすでに予約済みかどうかをチェック
                const selectedTime = formData.get('selectedTime');
                const isTimeBooked = reservations.some(r =>
                    r.visitDate === visitDate &&
                    r.visitTime === selectedTime &&
                    r.status !== 'cancelled' && // キャンセルされていない予約のみ対象
                    r.status !== 'completed' // 完了済みの予約も対象外にする場合 (運用による)
                );

                if (isTimeBooked) {
                    alert('選択された時間は既に予約が入っています。別の時間をお選びください。');
                    return;
                }

                try {
                    const newReservation = {
                        id: reservations.length > 0 ? Math.max(...reservations.map(r=>r.id))+1 : 1,
                        reservationNumber: generateReservationNumber(visitDate),
                        residentName: formData.get('residentName'),
                        visitorName: formData.get('visitorName'),
                        relationship: formData.get('relationship'),
                        visitDate: visitDate,
                        visitTime: formData.get('selectedTime'),
                        visitorCount: formData.get('visitorCount') || '1',
                        status: 'pending', // 初期ステータスは「承認待ち」
                        notes: formData.get('notes') || '',
                        createdAt: new Date().toLocaleString('ja-JP'),
                        temperature: "" // 体温は初期状態では空
                    };
                    reservations.push(newReservation);
                    saveReservations();
                    showConfirmation(newReservation); // 予約確認画面を表示
                    this.reset(); // フォームをリセット
                } catch (error) {
                    alert(error.message);
                }
            });

            // 予約確認画面表示（予約完了後）
            function showConfirmation(reservation) {
                document.getElementById('userFormContainer').style.display = 'none'; // フォームとボタンを非表示
                document.getElementById('confirmation').style.display = 'block'; // 確認画面を表示
                document.getElementById('reservationNumber').textContent = `予約番号: ${reservation.reservationNumber}`;
                document.getElementById('confirmationDetails').innerHTML = `
                    <p><strong>入居者様のお名前:</strong> ${reservation.residentName}</p>
                    <p><strong>面会者様のお名前:</strong> ${reservation.visitorName}</p>
                    <p><strong>ご関係:</strong> ${reservation.relationship}</p>
                    <p><strong>面会希望日:</strong> ${formatDate(reservation.visitDate)}</p>
                    <p><strong>面会希望時間:</strong> ${reservation.visitTime}</p>
                    <p><strong>面会者数:</strong> ${reservation.visitorCount}</p>
                    <p><strong>備考・特別な配慮事項:</strong> ${reservation.notes || 'なし'}</p>
                `;
            }

            // 新しい予約作成ボタン
            document.getElementById('newReservationBtn').onclick = showUserForm;

            // 利用者画面（フォームとボタン）を表示する関数
            function showUserForm() {
                document.getElementById('userFormContainer').style.display = 'block';
                document.getElementById('confirmation').style.display = 'none';
                document.getElementById('staffPanel').style.display = 'none'; // 職員画面は非表示に
                document.getElementById('reservationForm').reset(); // フォームをリセット
            }

            // --- 来設受付機能 ---
            const receptionBtn = document.getElementById('receptionBtn');
            const receptionModal = document.getElementById('receptionModal');
            const closeReceptionModalBtn = document.getElementById('closeReceptionModalBtn');
            const completeReceptionBtn = document.getElementById('completeReceptionBtn');
            const receptionNumberInput = document.getElementById('receptionNumberInput');
            const receptionTempInput = document.getElementById('receptionTempInput');
            const receptionResult = document.getElementById('receptionResult');

            receptionBtn.onclick = function() {
                receptionModal.style.display = 'flex';
                receptionResult.textContent = ''; // 結果メッセージをクリア
                receptionNumberInput.value = '';
                receptionTempInput.value = '';
            };
            closeReceptionModalBtn.onclick = function() {
                receptionModal.style.display = 'none';
            };
            window.addEventListener('click', function(event) {
                if (event.target === receptionModal) {
                    receptionModal.style.display = 'none';
                }
            });

            completeReceptionBtn.onclick = function() {
                const number = receptionNumberInput.value.trim();
                const temp = parseFloat(receptionTempInput.value);

                if (!number || isNaN(temp) || temp < 34 || temp > 42) {
                    receptionResult.style.color = '#e74c3c';
                    receptionResult.textContent = '受付番号と正しい体温を入力してください。';
                    return;
                }

                const reservationIndex = reservations.findIndex(r => r.reservationNumber === number);

                if (reservationIndex === -1) {
                    receptionResult.style.color = '#e74c3c';
                    receptionResult.textContent = '該当する予約が見つかりません。';
                    return;
                }

                if (reservations[reservationIndex].status === 'completed') {
                    receptionResult.style.color = '#e74c3c';
                    receptionResult.textContent = 'この予約はすでに完了しています。';
                    return;
                }
                if (reservations[reservationIndex].status === 'cancelled') {
                    receptionResult.style.color = '#e74c3c';
                    receptionResult.textContent = 'この予約はキャンセル済みです。';
                    return;
                }

                reservations[reservationIndex].status = 'completed';
                reservations[reservationIndex].temperature = temp.toFixed(1); // 体温を小数点以下1桁で保存
                saveReservations();
                receptionResult.style.color = '#4a7c59';
                receptionResult.textContent = `予約番号 ${number} の受付が完了しました。（体温: ${temp.toFixed(1)}℃）`;

                // 必要であれば、職員管理画面の統計を更新
                if (document.getElementById('staffPanel').style.display === 'block') {
                    updateStatistics();
                    renderReservations();
                }
            };

            // --- 予約キャンセル機能 (トップ画面から) ---
            const cancelTopButton = document.getElementById('cancelTopButton');
            const topCancelModal = document.getElementById('topCancelModal');
            const closeTopCancelModalBtn = document.getElementById('closeTopCancelModalBtn');
            const cancelReservationNumberInput = document.getElementById('cancelReservationNumberInput');
            const confirmCancelBtn = document.getElementById('confirmCancelBtn');
            const topCancelResult = document.getElementById('topCancelResult');

            cancelTopButton.onclick = function() {
                topCancelModal.style.display = 'flex';
                topCancelResult.textContent = ''; // 結果メッセージをクリア
                cancelReservationNumberInput.value = '';
            };
            closeTopCancelModalBtn.onclick = function() {
                topCancelModal.style.display = 'none';
            };
            window.addEventListener('click', function(event) {
                if (event.target === topCancelModal) {
                    topCancelModal.style.display = 'none';
                }
            });

            confirmCancelBtn.onclick = function() {
                const numberToCancel = cancelReservationNumberInput.value.trim();
                if (!numberToCancel) {
                    topCancelResult.style.color = '#e74c3c';
                    topCancelResult.textContent = '予約番号を入力してください。';
                    return;
                }

                const reservationIndex = reservations.findIndex(r => r.reservationNumber === numberToCancel);

                if (reservationIndex === -1) {
                    topCancelResult.style.color = '#e74c3c';
                    topCancelResult.textContent = '該当する予約が見つかりません。';
                    return;
                }

                if (reservations[reservationIndex].status === 'cancelled') {
                    topCancelResult.style.color = '#e74c3c';
                    topCancelResult.textContent = 'この予約はすでにキャンセル済みです。';
                    return;
                }
                if (reservations[reservationIndex].status === 'completed') {
                    topCancelResult.style.color = '#e74c3c';
                    topCancelResult.textContent = 'この予約は完了済みのため、キャンセルできません。';
                    return;
                }

                // 確認ダイアログ
                if (!confirm(`予約番号 ${numberToCancel} の予約をキャンセルしてもよろしいですか？`)) {
                    return;
                }

                reservations[reservationIndex].status = 'cancelled';
                saveReservations();
                topCancelResult.style.color = '#4a7c59';
                topCancelResult.textContent = `予約番号 ${numberToCancel} の予約をキャンセルしました。`;

                // 必要であれば、職員管理画面の統計を更新
                if (document.getElementById('staffPanel').style.display === 'block') {
                    updateStatistics();
                    renderReservations();
                }
            };


            // 職員認証
            const STAFF_PASSWORD = "nagomi753"; // 仮のパスワード
            document.getElementById('staffButton').onclick = function() {
                let pw = prompt("職員用パスワードを入力してください。");
                if (pw === null) return; // キャンセルされた場合
                if (pw === STAFF_PASSWORD) {
                    document.getElementById('userFormContainer').style.display = 'none'; // 利用者画面を非表示
                    document.getElementById('confirmation').style.display = 'none'; // 確認画面を非表示
                    document.getElementById('staffPanel').style.display = 'block'; // 職員管理画面を表示
                    renderReservations(); // 職員管理画面の予約一覧をレンダリング
                    updateStatistics(); // 統計情報を更新
                    // 削除対象日の初期値を昨日以前に設定
                    const today = new Date();
                    today.setDate(today.getDate() - 1); // 今日の1日前
                    document.getElementById('deleteDate').value = today.toISOString().split('T')[0];
                } else {
                    alert("パスワードが違います。");
                }
            };

            // 利用者画面に戻る
            document.getElementById('backUserFormBtn').onclick = showUserForm;

            function updateStatistics() {
                // キャンセル済みを除外して統計を計算
                const activeReservations = reservations.filter(r => r.status !== 'cancelled');
                document.getElementById('totalReservations').textContent = activeReservations.length;
                const today = new Date().toISOString().split('T')[0];
                const todayReservations = activeReservations.filter(r => r.visitDate === today).length;
                document.getElementById('todayReservations').textContent = todayReservations;
                const pendingReservations = activeReservations.filter(r => r.status === 'pending').length;
                document.getElementById('pendingReservations').textContent = pendingReservations;
                const completedReservations = activeReservations.filter(r => r.status === 'completed').length;
                document.getElementById('completedReservations').textContent = completedReservations;
            }

            function renderReservations(filteredList = null) {
                // 職員管理画面ではキャンセル済みの予約も表示する
                const list = filteredList || reservations;
                const container = document.getElementById('reservationsList');
                container.innerHTML = ''; // 一旦クリア

                if (list.length === 0) {
                    container.innerHTML = '<div style="padding:30px;text-align:center;color:#aaa;">該当する予約はありません。</div>';
                    return;
                }
                // 日付でソート (新しい日付が上に来るように)
                list.sort((a, b) => new Date(b.visitDate) - new Date(a.visitDate));

                list.forEach((r) => {
                    const item = document.createElement('div');
                    item.className = 'reservation-item';
                    item.innerHTML = `
                        <div class="reservation-number-display" data-id="${r.id}">${r.reservationNumber}</div>
                        <div class="reservation-field"><strong>入居者</strong>${r.residentName}</div>
                        <div class="reservation-field"><strong>面会者</strong>${r.visitorName} (${r.relationship})</div>
                        <div class="reservation-field"><strong>日時</strong>${formatDate(r.visitDate)} ${r.visitTime}</div>
                        <div class="reservation-field"><strong>人数</strong>${r.visitorCount}名</div>
                        <div class="reservation-field"><strong>体温</strong>${r.temperature ? r.temperature + '℃' : '未測定'}</div>
                        <div class="status-badge status-${r.status}" data-id="${r.id}">${getStatusText(r.status)}</div>
                    `;
                    container.appendChild(item);
                });

                // 各予約項目にクリックイベントを追加
                container.querySelectorAll('.reservation-number-display, .status-badge').forEach(el => {
                    el.addEventListener('click', function() {
                        const reservationId = parseInt(this.dataset.id);
                        const reservation = reservations.find(r => r.id === reservationId);
                        if (reservation) {
                            showReservationDetailModal(reservation);
                        }
                    });
                });
            }

            // 予約詳細モーダル表示 (職員管理画面内)
            const reservationModal = document.getElementById('reservationModal');
            const closeReservationModalBtn = document.getElementById('closeReservationModalBtn');
            const modalContent = document.getElementById('modalContent');

            closeReservationModalBtn.onclick = function() {
                reservationModal.style.display = 'none';
            };
            window.addEventListener('click', function(event) {
                if (event.target === reservationModal) {
                    reservationModal.style.display = 'none';
                }
            });

            function showReservationDetailModal(reservation) {
                modalContent.innerHTML = `
                    <div class="modal-detail"><strong>予約番号:</strong> ${reservation.reservationNumber}</div>
                    <div class="modal-detail"><strong>入居者様:</strong> ${reservation.residentName}</div>
                    <div class="modal-detail"><strong>面会者様:</strong> ${reservation.visitorName} (${reservation.relationship})</div>
                    <div class="modal-detail"><strong>面会日時:</strong> ${formatDate(reservation.visitDate)} ${reservation.visitTime}</div>
                    <div class="modal-detail"><strong>面会者数:</strong> ${reservation.visitorCount}名</div>
                    <div class="modal-detail"><strong>備考:</strong> ${reservation.notes || 'なし'}</div>
                    <div class="modal-detail"><strong>体温:</strong> <span id="modalTemp">${reservation.temperature ? reservation.temperature + '℃' : '未測定'}</span></div>
                    <div class="modal-detail"><strong>現在のステータス:</strong> <span id="modalStatus">${getStatusText(reservation.status)}</span></div>
                    ${reservation.status !== 'cancelled' ? `
                        <div class="status-buttons">
                            ${reservation.status !== 'confirmed' ? `<button class="status-btn confirmed" data-status="confirmed">承認済みに変更</button>` : ''}
                            ${reservation.status !== 'completed' ? `<button class="status-btn completed" data-status="completed">完了に変更</button>` : ''}
                            ${reservation.status !== 'cancelled' ? `<button class="status-btn cancelled" data-status="cancelled">キャンセル</button>` : ''}
                        </div>
                    ` : '<div style="margin-top:20px; color:#721c24; font-weight:bold;">この予約はキャンセル済みです。</div>'}
                `;

                // ステータス変更ボタンのイベントリスナー
                modalContent.querySelectorAll('.status-btn').forEach(btn => {
                    btn.onclick = function() {
                        const newStatus = this.dataset.status;
                        if (confirm(`ステータスを「${getStatusText(newStatus)}」に変更してもよろしいですか？`)) {
                            const currentTemp = reservation.temperature; // 変更前の体温を保持

                            // 完了にする場合のみ体温入力を促す
                            if (newStatus === 'completed' && (!currentTemp || currentTemp === "未測定")) {
                                let tempInput = prompt("体温を入力してください (例: 36.5)");
                                if (tempInput === null || tempInput.trim() === "") { // キャンセルまたは空の場合
                                    alert("体温が入力されませんでした。ステータスは変更されません。");
                                    return;
                                }
                                const parsedTemp = parseFloat(tempInput);
                                if (isNaN(parsedTemp) || parsedTemp < 34 || parsedTemp > 42) {
                                    alert("無効な体温です。正しい数値を入力してください。ステータスは変更されません。");
                                    return;
                                }
                                reservation.temperature = parsedTemp.toFixed(1); // 小数点以下1桁で保存
                            } else if (newStatus === 'completed' && currentTemp) {
                                // 既に体温が入力されている場合は確認
                                if (!confirm(`体温 ${currentTemp}℃ でこの予約を完了しますか？\n変更する場合はキャンセルして再度操作し、体温を変更してください。`)) {
                                    return; // ユーザーがキャンセルしたら処理を中断
                                }
                            }

                            reservation.status = newStatus;
                            saveReservations();
                            updateStatistics();
                            renderReservations(); // テーブルを再描画
                            reservationModal.style.display = 'none'; // モーダルを閉じる
                            alert(`予約番号 ${reservation.reservationNumber} のステータスを「${getStatusText(newStatus)}」に変更しました。`);
                        }
                    };
                });
                reservationModal.style.display = 'flex';
            }

            // フィルター機能
            document.getElementById('applyFiltersBtn').onclick = function() {
                const filterDate = document.getElementById('filterDate').value;
                const filterStatus = document.getElementById('filterStatus').value;
                const filterResident = document.getElementById('filterResident').value.toLowerCase();

                const filtered = reservations.filter(r => {
                    const matchesDate = filterDate ? r.visitDate === filterDate : true;
                    const matchesStatus = filterStatus ? r.status === filterStatus : true;
                    const matchesResident = filterResident ? r.residentName.toLowerCase().includes(filterResident) : true;
                    return matchesDate && matchesStatus && matchesResident;
                });
                renderReservations(filtered);
                updateStatistics(); // 統計も更新 (フィルタリングされた結果に基づく)
            };

            // 過去データ削除機能
            document.getElementById('deleteOldReservationsBtn').onclick = function() {
                const deleteDate = document.getElementById('deleteDate').value;
                if (!deleteDate) {
                    alert('削除対象日を選択してください。');
                    return;
                }

                if (!confirm(`${formatDate(deleteDate)} より過去の「完了済み」予約をすべて削除します。この操作は元に戻せません。本当によろしいですか？`)) {
                    return;
                }

                const initialCount = reservations.length;
                reservations = reservations.filter(r => !(r.status === 'completed' && r.visitDate < deleteDate));
                saveReservations();
                alert(`指定された条件の予約を削除しました。削除数: ${initialCount - reservations.length}件`);
                renderReservations(); // テーブルを再描画
                updateStatistics(); // 統計を更新
            };

            // ページロード時に利用者画面を表示
            showUserForm();
        });
    </script>
</body>
</html>
