<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>なごみの郷 面会予約アプリ</title>
  <style>
    /* 全体リセットと基本スタイル */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
        font-family: 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', 'Meiryo', sans-serif;
        background: linear-gradient(135deg, #e8f5e8 0%, #d4f4d4 100%);
        min-height: 100vh;
        padding: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }
    .container {
        max-width: 800px;
        width: 100%;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    .header {
        background: linear-gradient(135deg, #4a7c59 0%, #5d8a6b 100%);
        color: white;
        padding: 30px;
        text-align: center;
    }
    .header h1 { font-size: 2.2em; margin-bottom: 10px; font-weight: 600; }
    .header p { font-size: 1.1em; opacity: 0.9; }
    /* トップ画面のボタン共通スタイル */
    .top-button {
        display: block;
        text-align: center;
        text-decoration: none;
        padding: 12px 30px;
        border-radius: 8px;
        font-size: 1.1em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        width: 100%;
        margin-top: 15px;
        color: white;
        border: none;
    }

    .top-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    .submit-reservation-button {
        background: linear-gradient(135deg, #4a7c59 0%, #5d8a6b 100%);
    }
    .submit-reservation-button:hover {
        box-shadow: 0 5px 15px rgba(74, 124, 89, 0.3);
    }

    .reception-button {
        background-color: #FFD700;
        color: #000000;
    }
    .reception-button:hover {
        background-color: #e0c200;
    }

    .cancel-button {
        background-color: #dc3545;
    }
    .cancel-button:hover {
        background-color: #c82333;
    }

    .staff-button {
        background: #6c757d;
    }
    .staff-button:hover {
        background: #5a6268;
    }

    .form-container {
        padding: 40px;
        flex-grow: 1;
    }
    .form-group { margin-bottom: 25px; }
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #2d4a35;
        font-size: 1.1em;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1em;
        transition: border-color 0.3s;
        font-family: inherit;
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #4a7c59;
    }
    .form-group textarea {
        resize: vertical;
        min-height: 100px;
    }
    .required { color: #e74c3c; }

    .facility-info {
        background: #f8fcf8;
        padding: 25px;
        border-top: 1px solid #e0e0e0;
    }
    .facility-info h3 {
        color: #2d4a35;
        margin-bottom: 15px;
        font-size: 1.3em;
    }
    .info-item {
        margin-bottom: 8px;
        color: #4a4a4a;
    }
    .info-item strong { color: #2d4a35; }
    /* モーダル共通スタイル */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        background-color: white;
        margin: auto;
        padding: 30px;
        border-radius: 10px;
        width: 90%;
        max-width: 500px;
        position: relative;
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        position: absolute;
        right: 15px;
        top: 15px;
        cursor: pointer;
    }

    .close:hover { color: black; }

    .modal h3 {
        color: #2d4a35;
        margin-bottom: 20px;
        font-size: 1.4em;
    }

    .modal-detail {
        margin-bottom: 15px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 5px;
    }

    .modal-detail strong { color: #2d4a35; }

    .status-buttons {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }

    .status-btn {
        flex: 1;
        padding: 10px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9em;
        font-weight: bold;
        transition: all 0.3s;
    }

    .status-btn.confirmed { background: #d4edda; color: #155724; }
    .status-btn.completed { background: #d1ecf1; color: #0c5460; }
    .status-btn.cancelled { background: #f8d7da; color: #721c24; }

    .status-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* 職員管理画面スタイル */
    .staff-panel {
        display: none;
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        margin: 20px auto;
        max-width: 800px;
        width: 100%;
    }

    .staff-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e0e0e0;
    }

    .staff-header h2 {
        color: #2d4a35;
        font-size: 1.8em;
    }

    .back-button {
        background: #6c757d;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1em;
    }

    .back-button:hover {
        background: #5a6268;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: linear-gradient(135deg, #f8fcf8 0%, #e8f5e8 100%);
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        border: 2px solid #e0e0e0;
    }

    .stat-number {
        font-size: 2.5em;
        font-weight: bold;
        color: #4a7c59;
        margin-bottom: 5px;
    }

    .stat-label {
        color: #2d4a35;
        font-size: 1.1em;
    }
    .reservations-table {
        margin-bottom: 40px;
    }

    .table-header {
        font-size: 1.3em;
        color: #2d4a35;
        margin-bottom: 10px;
        font-weight: bold;
    }

    .table-content {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .reservation-item {
        padding: 15px;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        background: #f8f9fa;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 10px;
        cursor: pointer;
        transition: background 0.3s;
    }

    .reservation-item:hover {
        background: #e2f0e2;
    }

    .reservation-number-display {
        font-weight: bold;
        color: #4a7c59;
    }

    .status-badge {
        padding: 6px 10px;
        border-radius: 5px;
        font-weight: bold;
        font-size: 0.9em;
        text-align: center;
        width: fit-content;
    }

    .status-pending { background: #fff3cd; color: #856404; }
    .status-confirmed { background: #d4edda; color: #155724; }
    .status-completed { background: #d1ecf1; color: #0c5460; }
    .status-cancelled { background: #f8d7da; color: #721c24; }

    .filter-section {
        margin-bottom: 30px;
    }

    .filter-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 15px;
        align-items: flex-end;
    }

    .filter-group label {
        display: block;
        font-weight: bold;
        margin-bottom: 5px;
        color: #2d4a35;
    }

    .filter-button {
        padding: 10px 20px;
        background: #4a7c59;
        color: white;
        border: none;
        border-radius: 5px;
        font-weight: bold;
        cursor: pointer;
    }

    .delete-old-data-section {
        margin-top: 30px;
    }

    .delete-old-data-section h3 {
        margin-bottom: 10px;
        color: #2d4a35;
    }

    .delete-old-data-section p {
        margin-bottom: 15px;
        color: #4a4a4a;
    }

    .delete-row {
        display: flex;
        gap: 15px;
        align-items: flex-end;
    }

    .delete-button {
        padding: 10px 20px;
        background: #e74c3c;
        color: white;
        border: none;
        border-radius: 5px;
        font-weight: bold;
        cursor: pointer;
    }

    .delete-old-data-section .delete-button:hover {
        background: #c0392b;
        transform: translateY(-1px);
    }
<body>
    <!-- ランディングページ -->
    <div class="welcome-page" id="welcomePage">
        <h1>なごみの郷面会予約アプリへようこそ！</h1>
        <p>面会予約はこちらから行えます。</p>
        <button class="start-button" id="startReservationBtn">面会予約システムへ</button>
    </div>

    <!-- メインアプリコンテナ -->
    <div class="container" id="mainAppContainer" style="display:none;">
        <div class="header">
            <h1>なごみの郷 面会予約システム</h1>
            <p>オンラインで簡単に面会予約ができます</p>
        </div>

        <!-- ユーザーフォーム -->
        <div class="form-container" id="userFormContainer">
            <form id="reservationForm">
                <div class="form-group">
                    <label for="residentName">入居者様のお名前 <span class="required">*</span></label>
                    <input type="text" id="residentName" name="residentName" required>
                </div>

                <div class="form-group">
                    <label for="visitorName">面会者様のお名前 <span class="required">*</span></label>
                    <input type="text" id="visitorName" name="visitorName" required>
                </div>

                <div class="form-group">
                    <label for="relationship">ご関係 <span class="required">*</span></label>
                    <input type="text" id="relationship" name="relationship" placeholder="例: 息子、娘、配偶者" required>
                </div>

                <div class="form-group">
                    <label for="visitDate">面会希望日 <span class="required">*</span></label>
                    <input type="date" id="visitDate" name="visitDate" required>
                </div>

                <div class="form-group">
                    <label for="selectedTime">面会希望時間 <span class="required">*</span></label>
                    <select id="selectedTime" name="selectedTime" required>
                        <option value="">選択してください</option>
                        <option value="10:00">10:00</option>
                        <option value="10:30">10:30</option>
                        <option value="11:00">11:00</option>
                        <option value="11:30">11:30</option>
                        <option value="12:00">12:00</option>
                        <option value="12:30">12:30</option>
                        <option value="13:00">13:00</option>
                        <option value="13:30">13:30</option>
                        <option value="14:00">14:00</option>
                        <option value="14:30">14:30</option>
                        <option value="15:00">15:00</option>
                        <option value="15:30">15:30</option>
                        <option value="16:00">16:00</option>
                        <option value="16:30">16:30</option>
                        <option value="17:00">17:00</option>
                        <option value="17:30">17:30</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="visitorCount">面会者数</label>
                    <select id="visitorCount" name="visitorCount">
                        <option value="1">1名</option>
                        <option value="2">2名</option>
                        <option value="3">3名</option>
                        <option value="4">4名</option>
                        <option value="5">5名以上</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="notes">備考・特別な配慮事項</label>
                    <textarea id="notes" name="notes" placeholder="アレルギー、健康状態、車椅子使用など"></textarea>
                </div>

                <button type="submit" class="top-button submit-reservation-button">予約を送信</button>
                <button type="button" id="receptionBtn" class="top-button reception-button">来設受付</button>
                <button type="button" id="cancelTopButton" class="top-button cancel-button">予約をキャンセル</button>
                <button type="button" id="staffButton" class="top-button staff-button">職員専用</button>
            </form>
            <!-- 来設受付モーダル -->
            <div id="receptionModal" class="modal">
                <div class="modal-content">
                    <span class="close" id="closeReceptionModalBtn">&times;</span>
                    <h3>来設受付</h3>
                    <div style="margin-bottom:15px;">受付番号（予約番号）と体温を入力してください。</div>
                    <input type="text" id="receptionNumberInput" placeholder="例: 20250720-001">
                    <input type="number" id="receptionTempInput" placeholder="体温（例：36.7）" min="34" max="42" step="0.1">
                    <div id="receptionResult" style="margin:15px 0;color:#4a7c59;"></div>
                    <button type="button" class="submit-btn" id="completeReceptionBtn">受付を完了する</button>
                </div>
            </div>

            <!-- 予約キャンセルモーダル -->
            <div id="topCancelModal" class="modal">
                <div class="modal-content">
                    <span class="close" id="closeTopCancelModalBtn">&times;</span>
                    <h3>予約キャンセル</h3>
                    <p style="margin-bottom: 15px;">キャンセルする予約の予約番号を入力してください。</p>
                    <input type="text" id="cancelReservationNumberInput" placeholder="例: 20250720-001">
                    <div id="topCancelResult" style="margin:15px 0;color:#721c24;"></div>
                    <button type="button" class="submit-btn" id="confirmCancelBtn" style="background:#dc3545;">キャンセルを実行</button>
                </div>
            </div>

            <!-- 予約完了確認画面 -->
            <div class="confirmation" id="confirmation" style="display:none;">
                <h3>面会予約を受け付けました</h3>
                <div class="reservation-number" id="reservationNumber"></div>
                <p>ご予約ありがとうございます。以下の内容でご予約を受け付けいたしました。</p>
                <div class="confirmation-details" id="confirmationDetails"></div>
                <button class="new-reservation-button" id="newReservationBtn">新しい予約を作成</button>
            </div>
        </div>
        <!-- 職員専用パネル -->
        <div class="staff-panel" id="staffPanel" style="display:none;">
            <div class="staff-header">
                <h2>職員管理画面</h2>
                <button class="back-button" id="backUserFormBtn">利用者画面に戻る</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalReservations">0</div>
                    <div class="stat-label">総予約数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="todayReservations">0</div>
                    <div class="stat-label">本日の予約</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pendingReservations">0</div>
                    <div class="stat-label">承認待ち</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completedReservations">0</div>
                    <div class="stat-label">完了済み</div>
                </div>
            </div>

            <div class="filter-section">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="filterDate">日付</label>
                        <input type="date" id="filterDate">
                    </div>
                    <div class="filter-group">
                        <label for="filterStatus">ステータス</label>
                        <select id="filterStatus">
                            <option value="">すべて</option>
                            <option value="pending">承認待ち</option>
                            <option value="confirmed">承認済み</option>
                            <option value="completed">完了</option>
                            <option value="cancelled">キャンセル</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterResident">入居者名</label>
                        <input type="text" id="filterResident" placeholder="入居者名で検索">
                    </div>
                    <div class="filter-group">
                        <button class="filter-button" id="applyFiltersBtn">フィルター適用</button>
                    </div>
                </div>
            </div>

            <div class="reservations-table">
                <div class="table-header">面会予約一覧</div>
                <div class="table-content" id="reservationsList"></div>
            </div>

            <div class="delete-old-data-section">
                <h3>過去の面会予約データを削除</h3>
                <p>指定した日付より過去の「全てのステータス」の予約を削除します。この操作は元に戻せません。</p>
                <div class="delete-row">
                    <div class="filter-group" style="flex-grow: 1;">
                        <label for="deleteDate">削除対象日（この日付より過去）</label>
                        <input type="date" id="deleteDate">
                    </div>
                    <button class="delete-button" id="deleteOldReservationsBtn">削除実行</button>
                </div>
            </div>
        </div>

        <!-- 施設情報 -->
        <div class="facility-info">
            <h3>施設情報</h3>
            <div class="info-item"><strong>施設名:</strong> 特別養護老人ホーム・ケアハウス なごみの郷</div>
            <div class="info-item"><strong>所在地:</strong> 〒739-1732 広島県広島市安佐南区沼田南町196-1</div>
            <div class="info-item"><strong>面会時間:</strong> 10:00～17:30 / 年中無休</div>
            <div class="info-item"><strong>お問い合わせ:</strong> 082-841-1331</div>
        </div>
        <!-- 予約詳細モーダル（職員用） -->
        <div id="reservationModal" class="modal">
            <div class="modal-content">
                <span class="close" id="closeReservationModalBtn">&times;</span>
                <h3>予約詳細</h3>
                <div id="modalContent"></div>
            </div>
        </div>

        <!-- JavaScript -->
        <script>
        document.addEventListener("DOMContentLoaded", function() {
            const welcomePage = document.getElementById('welcomePage');
            const mainAppContainer = document.getElementById('mainAppContainer');
            const startReservationBtn = document.getElementById('startReservationBtn');

            // LocalStorageから予約情報を取得
            function loadReservations() {
                const data = localStorage.getItem('nagomi_reservations');
                if (data) {
                    try {
                        return JSON.parse(data);
                    } catch {
                        return [];
                    }
                }
                return [];
            }

            // LocalStorageに予約情報を保存
            function saveReservations() {
                localStorage.setItem('nagomi_reservations', JSON.stringify(reservations));
            }

            let reservations = loadReservations();

            // 初回アクセス時のダミーデータ
            if (!reservations || !Array.isArray(reservations) || reservations.length === 0) {
                reservations = [
                    {
                        id: 1,
                        reservationNumber: "20250717-001",
                        residentName: "田中 花子",
                        visitorName: "田中 太郎",
                        relationship: "息子",
                        visitDate: "2025-07-17",
                        visitTime: "14:00",
                        visitorCount: "2",
                        status: "pending",
                        notes: "車椅子使用",
                        createdAt: "2025-07-16 10:30",
                        temperature: ""
                    }
                ];
                saveReservations();
            }

            // 最小日付を今日に制限
            document.getElementById('visitDate').min = new Date().toISOString().split('T')[0];

            // 日付表示整形
            function formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('ja-JP', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }

            // ステータスを日本語に変換
            function getStatusText(status) {
                switch (status) {
                    case 'pending':
                        return '承認待ち';
                    case 'confirmed':
                        return '承認済み';
                    case 'completed':
                        return '完了';
                    case 'cancelled':
                        return 'キャンセル';
                    default:
                        return status;
                }
            }
            // 予約番号を生成（例: 20250722-001）
            function generateReservationNumber(visitDate) {
                const dateString = visitDate.replace(/-/g, '');
                const sameDayReservations = reservations.filter(r => r.visitDate === visitDate);
                const nextNumber = sameDayReservations.length + 1;
                if (nextNumber > 999) {
                    throw new Error('その日は予約が満席です（1日最大999件まで）');
                }
                return `${dateString}-${nextNumber.toString().padStart(3, '0')}`;
            }

            // 面会予約フォーム送信処理
            document.getElementById('reservationForm').addEventListener('submit', function (e) {
                e.preventDefault();

                const formData = new FormData(this);
                const visitDate = formData.get('visitDate');
                const selectedTime = formData.get('selectedTime');

                if (!visitDate || !selectedTime) {
                    alert('日付と時間を選択してください。');
                    return;
                }

                // 予約済み時間のチェック（キャンセル・完了は除外）
                const isBooked = reservations.some(r =>
                    r.visitDate === visitDate &&
                    r.visitTime === selectedTime &&
                    r.status !== 'cancelled' &&
                    r.status !== 'completed'
                );
                if (isBooked) {
                    alert('選択された時間はすでに予約されています。別の時間をお選びください。');
                    return;
                }

                try {
                    const newReservation = {
                        id: reservations.length > 0 ? Math.max(...reservations.map(r => r.id)) + 1 : 1,
                        reservationNumber: generateReservationNumber(visitDate),
                        residentName: formData.get('residentName'),
                        visitorName: formData.get('visitorName'),
                        relationship: formData.get('relationship'),
                        visitDate: visitDate,
                        visitTime: selectedTime,
                        visitorCount: formData.get('visitorCount') || '1',
                        status: 'pending',
                        notes: formData.get('notes') || '',
                        createdAt: new Date().toLocaleString('ja-JP'),
                        temperature: ""
                    };

                    reservations.push(newReservation);
                    saveReservations();
                    showConfirmation(newReservation);
                    this.reset();

                } catch (err) {
                    alert(err.message);
                }
            });

            // 確認画面を表示
            function showConfirmation(reservation) {
                document.getElementById('userFormContainer').style.display = 'none';
                document.getElementById('confirmation').style.display = 'block';
                document.getElementById('reservationNumber').textContent = `予約番号: ${reservation.reservationNumber}`;
                document.getElementById('confirmationDetails').innerHTML = `
                    <p><strong>入居者様のお名前:</strong> ${reservation.residentName}</p>
                    <p><strong>面会者様のお名前:</strong> ${reservation.visitorName}</p>
                    <p><strong>ご関係:</strong> ${reservation.relationship}</p>
                    <p><strong>面会希望日:</strong> ${formatDate(reservation.visitDate)}</p>
                    <p><strong>面会希望時間:</strong> ${reservation.visitTime}</p>
                    <p><strong>面会者数:</strong> ${reservation.visitorCount}</p>
                    <p><strong>備考・特別な配慮事項:</strong> ${reservation.notes || 'なし'}</p>
                `;
            }

            document.getElementById('newReservationBtn').onclick = showUserForm;

            // フォーム再表示（戻る）
            function showUserForm() {
                welcomePage.style.display = 'none';
                mainAppContainer.style.display = 'flex';
                document.getElementById('userFormContainer').style.display = 'block';
                document.getElementById('confirmation').style.display = 'none';
                document.getElementById('staffPanel').style.display = 'none';
                document.getElementById('reservationForm').reset();
            }
            // --- 来設受付モーダル関連 ---
            const receptionBtn = document.getElementById('receptionBtn');
            const receptionModal = document.getElementById('receptionModal');
            const closeReceptionModalBtn = document.getElementById('closeReceptionModalBtn');
            const completeReceptionBtn = document.getElementById('completeReceptionBtn');
            const receptionNumberInput = document.getElementById('receptionNumberInput');
            const receptionTempInput = document.getElementById('receptionTempInput');
            const receptionResult = document.getElementById('receptionResult');

            // モーダルを開く
            receptionBtn.onclick = function () {
                receptionModal.style.display = 'flex';
                receptionResult.textContent = '';
                receptionNumberInput.value = '';
                receptionTempInput.value = '';
            };

            // モーダルを閉じる（×ボタン）
            closeReceptionModalBtn.onclick = function () {
                receptionModal.style.display = 'none';
            };

            // モーダル背景クリックで閉じる
            window.addEventListener('click', function (event) {
                if (event.target === receptionModal) {
                    receptionModal.style.display = 'none';
                }
            });

            // 受付完了処理
            completeReceptionBtn.onclick = function () {
                const reservationNumber = receptionNumberInput.value.trim();
                const temperature = receptionTempInput.value.trim();
                receptionResult.style.color = '#721c24'; // 初期はエラー色

                if (!reservationNumber) {
                    receptionResult.textContent = '受付番号（予約番号）を入力してください。';
                    return;
                }
                if (!temperature) {
                    receptionResult.textContent = '体温を入力してください。';
                    return;
                }
                if (isNaN(parseFloat(temperature))) {
                    receptionResult.textContent = '有効な体温を入力してください。';
                    return;
                }

                const reservationIndex = reservations.findIndex(r => r.reservationNumber === reservationNumber);

                if (reservationIndex === -1) {
                    receptionResult.textContent = '該当する予約が見つかりません。予約番号を確認してください。';
                    return;
                }

                const reservation = reservations[reservationIndex];

                if (reservation.status === 'completed') {
                    receptionResult.textContent = 'この予約はすでに受付完了済みです。';
                    return;
                }
                if (reservation.status === 'cancelled') {
                    receptionResult.textContent = 'この予約はキャンセルされています。';
                    return;
                }

                if (parseFloat(temperature) >= 37.5) {
                    receptionResult.textContent = `体温が ${temperature}℃ です。面会の可否をご判断ください。`;
                    receptionResult.style.color = '#dc3545';
                } else {
                    receptionResult.textContent = '受付が完了しました。';
                    receptionResult.style.color = '#4a7c59';
                }

                reservation.status = 'completed';
                reservation.temperature = temperature;
                saveReservations();
                updateStaffPanel(); // 職員画面を更新
            };
            // --- トップ画面からの予約キャンセル機能 ---
            const cancelTopButton = document.getElementById('cancelTopButton');
            const topCancelModal = document.getElementById('topCancelModal');
            const closeTopCancelModalBtn = document.getElementById('closeTopCancelModalBtn');
            const cancelReservationNumberInput = document.getElementById('cancelReservationNumberInput');
            const confirmCancelBtn = document.getElementById('confirmCancelBtn');
            const topCancelResult = document.getElementById('topCancelResult');

            cancelTopButton.onclick = function () {
                topCancelModal.style.display = 'flex';
                cancelReservationNumberInput.value = '';
                topCancelResult.textContent = '';
            };

            closeTopCancelModalBtn.onclick = function () {
                topCancelModal.style.display = 'none';
            };

            window.addEventListener('click', function (event) {
                if (event.target === topCancelModal) {
                    topCancelModal.style.display = 'none';
                }
            });

            confirmCancelBtn.onclick = function () {
                const reservationNumber = cancelReservationNumberInput.value.trim();
                topCancelResult.style.color = '#721c24'; // デフォルト赤文字

                if (!reservationNumber) {
                    topCancelResult.textContent = 'キャンセルする予約番号を入力してください。';
                    return;
                }

                const reservationIndex = reservations.findIndex(r => r.reservationNumber === reservationNumber);

                if (reservationIndex === -1) {
                    topCancelResult.textContent = '該当する予約が見つかりません。予約番号を確認してください。';
                    return;
                }

                if (reservations[reservationIndex].status === 'cancelled') {
                    topCancelResult.textContent = 'この予約は既にキャンセル済みです。';
                    return;
                }

                // 確認ダイアログ
                if (confirm(`予約番号: ${reservationNumber} の面会予約をキャンセルしますか？\nこの操作は元に戻せません。`)) {
                    reservations[reservationIndex].status = 'cancelled';
                    saveReservations();
                    topCancelResult.textContent = '予約をキャンセルしました。';
                    topCancelResult.style.color = '#4a7c59'; // 成功色
                    updateStaffPanel();
                } else {
                    topCancelResult.textContent = 'キャンセルを中止しました。';
                }
            };
            // --- 職員専用画面機能 ---
            const staffButton = document.getElementById('staffButton');
            const staffPanel = document.getElementById('staffPanel');
            const backUserFormBtn = document.getElementById('backUserFormBtn');
            const reservationsList = document.getElementById('reservationsList');
            const filterDateInput = document.getElementById('filterDate');
            const filterStatusSelect = document.getElementById('filterStatus');
            const filterResidentInput = document.getElementById('filterResident');
            const applyFiltersBtn = document.getElementById('applyFiltersBtn');
            const deleteDateInput = document.getElementById('deleteDate');
            const deleteOldReservationsBtn = document.getElementById('deleteOldReservationsBtn');

            staffButton.onclick = function () {
                mainAppContainer.style.display = 'none';
                welcomePage.style.display = 'none';
                staffPanel.style.display = 'block';
                updateStaffPanel();
            };

            backUserFormBtn.onclick = showUserForm;

            function updateStaffPanel() {
                updateStats();
                renderReservations();
            }

            function updateStats() {
                const today = new Date().toISOString().split('T')[0];
                const total = reservations.length;
                const todayCount = reservations.filter(r => r.visitDate === today && r.status !== 'cancelled' && r.status !== 'completed').length;
                const pending = reservations.filter(r => r.status === 'pending').length;
                const completed = reservations.filter(r => r.status === 'completed').length;

                document.getElementById('totalReservations').textContent = total;
                document.getElementById('todayReservations').textContent = todayCount;
                document.getElementById('pendingReservations').textContent = pending;
                document.getElementById('completedReservations').textContent = completed;
            }
            function renderReservations() {
                reservationsList.innerHTML = ''; // 既存表示をクリア

                // キャンセル済み以外で、日付＋時間でソート
                let filteredReservations = reservations
                    .filter(r => r.status !== 'cancelled')
                    .sort((a, b) => new Date(`${a.visitDate}T${a.visitTime}`) - new Date(`${b.visitDate}T${b.visitTime}`));

                // 各種フィルター適用
                const filterDate = filterDateInput.value;
                const filterStatus = filterStatusSelect.value;
                const filterResident = filterResidentInput.value.toLowerCase();

                if (filterDate) {
                    filteredReservations = filteredReservations.filter(r => r.visitDate === filterDate);
                }
                if (filterStatus) {
                    filteredReservations = filteredReservations.filter(r => r.status === filterStatus);
                }
                if (filterResident) {
                    filteredReservations = filteredReservations.filter(r =>
                        r.residentName.toLowerCase().includes(filterResident) ||
                        r.visitorName.toLowerCase().includes(filterResident)
                    );
                }

                if (filteredReservations.length === 0) {
                    reservationsList.innerHTML = '<p style="padding: 20px; text-align: center; color: #666;">該当する予約はありません。</p>';
                    return;
                }

                filteredReservations.forEach(reservation => {
                    const item = document.createElement('div');
                    item.className = 'reservation-item';
                    item.setAttribute('data-id', reservation.id);

                    const statusClass = `status-${reservation.status}`;
                    const temperatureDisplay = reservation.temperature ? ` (${reservation.temperature}°C)` : '';

                    item.innerHTML = `
                        <div class="reservation-number-display">${reservation.reservationNumber}</div>
                        <div class="reservation-field"><strong>入居者:</strong> ${reservation.residentName}</div>
                        <div class="reservation-field"><strong>面会者:</strong> ${reservation.visitorName}</div>
                        <div class="reservation-field"><strong>日時:</strong> ${formatDate(reservation.visitDate)} ${reservation.visitTime}</div>
                        <div class="reservation-field"><strong>人数:</strong> ${reservation.visitorCount}</div>
                        <div class="reservation-field"><strong>備考:</strong> ${reservation.notes || 'なし'}${temperatureDisplay}</div>
                        <div class="status-badge ${statusClass}" data-status="${reservation.status}">${getStatusText(reservation.status)}</div>
                    `;

                    reservationsList.appendChild(item);
                });

                // クリックで詳細モーダル表示
                reservationsList.querySelectorAll('.reservation-item').forEach(item => {
                    item.addEventListener('click', function () {
                        const reservationId = parseInt(this.getAttribute('data-id'));
                        const clickedReservation = reservations.find(r => r.id === reservationId);
                        if (clickedReservation) {
                            showReservationDetailsModal(clickedReservation);
                        }
                    });
                });
            }

            applyFiltersBtn.onclick = renderReservations;
            // --- 予約詳細モーダル機能（職員専用） ---
            const reservationModal = document.getElementById('reservationModal');
            const closeReservationModalBtn = document.getElementById('closeReservationModalBtn');
            const modalContent = document.getElementById('modalContent');

            closeReservationModalBtn.onclick = function () {
                reservationModal.style.display = 'none';
            };

            window.addEventListener('click', function (event) {
                if (event.target === reservationModal) {
                    reservationModal.style.display = 'none';
                }
            });

            function showReservationDetailsModal(reservation) {
                modalContent.innerHTML = `
                    <div class="modal-detail"><p><strong>予約番号:</strong> ${reservation.reservationNumber}</p></div>
                    <div class="modal-detail"><p><strong>入居者様のお名前:</strong> ${reservation.residentName}</p></div>
                    <div class="modal-detail"><p><strong>面会者様のお名前:</strong> ${reservation.visitorName}</p></div>
                    <div class="modal-detail"><p><strong>ご関係:</strong> ${reservation.relationship}</p></div>
                    <div class="modal-detail"><p><strong>面会希望日:</strong> ${formatDate(reservation.visitDate)}</p></div>
                    <div class="modal-detail"><p><strong>面会希望時間:</strong> ${reservation.visitTime}</p></div>
                    <div class="modal-detail"><p><strong>面会者数:</strong> ${reservation.visitorCount}</p></div>
                    <div class="modal-detail"><p><strong>備考・特別な配慮事項:</strong> ${reservation.notes || 'なし'}</p></div>
                    <div class="modal-detail"><p><strong>体温:</strong> ${reservation.temperature ? reservation.temperature + '°C' : '未計測'}</p></div>
                    <div class="modal-detail"><p><strong>予約日時:</strong> ${reservation.createdAt}</p></div>
                    <div class="modal-detail"><p><strong>現在のステータス:</strong> <span class="status-badge status-${reservation.status}">${getStatusText(reservation.status)}</span></p></div>
                    <div class="status-buttons">
                        <button class="status-btn confirmed" data-status="confirmed" data-id="${reservation.id}">承認済みに変更</button>
                        <button class="status-btn completed" data-status="completed" data-id="${reservation.id}">完了済みに変更</button>
                        <button class="status-btn cancelled" data-status="cancelled" data-id="${reservation.id}">キャンセル済みに変更</button>
                    </div>
                `;
                reservationModal.style.display = 'flex';

                // ステータス変更ボタンの処理
                modalContent.querySelectorAll('.status-btn').forEach(button => {
                    button.onclick = function () {
                        const newStatus = this.getAttribute('data-status');
                        const resId = parseInt(this.getAttribute('data-id'));
                        const resIndex = reservations.findIndex(r => r.id === resId);

                        if (resIndex !== -1) {
                            if (confirm(`${getStatusText(newStatus)} にステータスを変更しますか？`)) {
                                reservations[resIndex].status = newStatus;
                                saveReservations();
                                updateStaffPanel(); // リスト更新
                                reservationModal.style.display = 'none'; // モーダルを閉じる
                                alert('ステータスが更新されました。');
                            }
                        }
                    };
                });
            }
            // --- 過去データ削除機能 ---
            deleteOldReservationsBtn.onclick = function () {
                const deleteDate = deleteDateInput.value;
                if (!deleteDate) {
                    alert('削除対象の日付を選択してください。');
                    return;
                }

                if (!confirm(`${formatDate(deleteDate)} 以前の「全てのステータス」の予約をすべて削除します。\nこの操作は元に戻せません。本当によろしいですか？`)) {
                    return;
                }

                const initialLength = reservations.length;
                reservations = reservations.filter(r => new Date(r.visitDate) >= new Date(deleteDate));
                saveReservations();
                updateStaffPanel();
                alert(`${initialLength - reservations.length} 件の過去の予約が削除されました。`);
                deleteDateInput.value = '';
            };

            // --- アプリケーションの初期表示設定 ---
            welcomePage.style.display = 'flex';
            mainAppContainer.style.display = 'none';

            // 「面会予約システムへ」ボタンのクリックでフォーム表示
            startReservationBtn.onclick = showUserForm;

            // 職員管理画面の統計を初期化
            updateStaffPanel();
        });
    </script>
</body>
</html>

